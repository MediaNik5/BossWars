package Boss;

import java.util.ArrayList;
import java.util.List;
import java.util.Timer;
import java.util.TimerTask;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.World;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;

public class Boss extends JavaPlugin implements Listener {
	private static Boss instance;
	FileConfiguration config = getConfig();
	int i, b, t;
	int o;
	String worldName;
	List<Player> players = new ArrayList<>();
	Pos pos;
	Player q;
	List<World> worlds = new ArrayList<>();
	Location locc;
	Timer timer=new Timer();
	
	public static Boss instance(){
		return instance;
	}
	
	public class Pos {
	    public String worldName;
	    public double x, y, z;
	 
	    public Pos(String name, double x, double y, double z) {
	        worldName = name;
	        this.x = x;
	        this.y = y;
	        this.z = z;
	    }
	}
	
	public void locToConfig(String world, Location loc){
		pos = new Pos(world, loc.getX(), loc.getY(), loc.getZ());
		config.set("Locations.lobby.world", pos.worldName);
		config.set("Locations.lobby.x", pos.x);
		config.set("Locations.lobby.y", pos.y);
		config.set("Locations.lobby.z", pos.z);
		saveConfig();
	}
	
	
	public void onEnable(){
		Bukkit.getServer().getPluginManager().registerEvents(this, this);
		this.saveDefaultConfig();
		pos = new Pos(config.getString("Locations.lobby.world"), 
				config.getDouble("Locations.lobby.x"), 
				config.getDouble("Locations.lobby.y"), 
				config.getDouble("Locations.lobby.z"));
			getLogger().info(pos.worldName + " " + pos.x + " " + pos.y + " " + pos.z);
			
			
	}
	public void onDisable(){
		players.clear();
	}
	
	public boolean chekSender (CommandSender sen){
		if(sen instanceof Player){return false;}return true;		
	}
	
	public boolean onCommand (CommandSender sen, Command cmd, String label, String[] args){
		if(cmd.getName().equalsIgnoreCase("breload")){
			reloadConfig();
			sen.sendMessage(ChatColor.GREEN + "Plugin BossWars was reloaded");
		}
		if(cmd.getName().equalsIgnoreCase("setlobby")){	
			if(chekSender(sen)){
				sen.sendMessage(ChatColor.RED + "Only players can use this command");
				return true;
			}if(args.length ==0)return false;
			Player p = (Player) sen;
			Location loc = p.getLocation();
			locToConfig(args[0], loc);
			sen.sendMessage(ChatColor.GREEN + "Лобби установлено");
			return true;
		}
		if(cmd.getName().equalsIgnoreCase("enter")){
			if(chekSender(sen)){
				sen.sendMessage(ChatColor.RED + "Only players can use this command");
				return true;
			}
			Player p = (Player) sen;
			/*if(players.contains(p)){
				p.sendMessage(ChatColor.RED + "Вы уже в очереди!!!");
				return true;
			}*/
			players.add(p);
			p.sendMessage(ChatColor.GREEN + "Вы вошли в очередь");
			if(players.size() == 2){
				for(i=0; i<2; i++){
					p = players.get(i);
					World world = Bukkit.getWorld(pos.worldName);
					p.teleport(new Location(world, pos.x, pos.y, pos.z));
				}
				toPlay();
			
			}
			if(players.size() > 2) {
				World world = Bukkit.getWorld(pos.worldName);
				p.teleport(new Location(world, pos.x, pos.y, pos.z));
			}
		return true;
		}
		return true;
	
	}
	TimerTask mytimer = new myTask();
	

	public void toPlay(){
		for(i=15; i>0; i--){
			
			b = players.size();
			timer.schedule( mytimer,10000);
			for(o=0;o<b;o++){
			q = players.get(o);
			q.setLevel(i);
			}
		}
	}public class myTask extends TimerTask{
		public void run(){
			for(o=0;o<b;o++){
				q = players.get(o);
				q.setLevel(i);
				}
		}
		}
}
